name: Minimal CI/CD Vercel + VinaHost

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  frontend-build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4
      - name: Test frontend files
        run: |
          ls -la
          echo "Frontend files exist"

  backend-build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4
      - name: Test backend
        run: |
          python --version
          echo "Backend ready"

  frontend-deploy:
    runs-on: ubuntu-latest
    needs: frontend-build
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
           npm install -g vercel
           vercel --prod --token $VERCEL_TOKEN --yes --scope $VERCEL_ORG_ID --confirm

  backend-deploy:
    runs-on: ubuntu-latest
    needs: backend-build
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4
      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp
      - name: Deploy backend via FTP to VinaHost
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASS }}
        run: |
          lftp -c "
            open -u $FTP_USER,$FTP_PASS $FTP_HOST
            mirror -R --delete --parallel=2 ./ /public_html/backend/
          "
