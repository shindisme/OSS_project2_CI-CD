name: Minimal CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  frontend-build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4
      - name: Test HTML/JS exists
        run: |
          ls -la
          echo "Frontend files present"

  backend-build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4
      - name: Test Python backend
        run: |
          python --version
          python server.py & sleep 3
          curl http://localhost:5000/api/hello
          kill %1 || true

  frontend-deploy:
    runs-on: ubuntu-latest
    needs: frontend-build
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to Netlify
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          npm install -g netlify-cli
          netlify deploy --prod --dir=. --site $NETLIFY_SITE_ID --auth $NETLIFY_AUTH_TOKEN

  backend-deploy:
    runs-on: ubuntu-latest
    needs: backend-build
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4
      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp
      - name: Deploy backend via FTP to VinaHost
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASS }}
        run: |
          lftp -c "
            open -u $FTP_USER,$FTP_PASS $FTP_HOST
            mirror -R --delete --parallel=2 ./ /public_html/backend/
          "
